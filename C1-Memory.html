<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Python Memory Audit</title>
    <style>
        :root { --stack: #58a6ff; --heap: #d2a8ff; --gc: #ff7b72; --bg: #0d1117; --list: #d29922; --literal: #39c5cf; }
        body { font-family: 'Segoe UI', Tahoma, sans-serif; background: var(--bg); color: #c9d1d9; padding: 20px; display: flex; flex-direction: column; align-items: center; }
        
        .controls { background: #161b22; padding: 20px; border-radius: 8px; border: 1px solid #30363d; display: flex; gap: 10px; margin-bottom: 20px; width: 100%; max-width: 900px; }
        input { flex-grow: 1; padding: 12px; border-radius: 4px; border: 1px solid #30363d; background: #010409; color: #7ee787; font-family: monospace; font-size: 1.1em; }
        button { padding: 10px 15px; border-radius: 4px; border: none; cursor: pointer; font-weight: bold; color: white; background: #238636; }
        
        .main-layout { display: flex; gap: 20px; width: 100%; max-width: 900px; }
        .column { background: #161b22; border-radius: 8px; padding: 15px; border: 1px solid #30363d; flex: 1; min-height: 400px; }
        
        .item { padding: 10px; margin: 8px 0; border-radius: 6px; background: #0d1117; border: 1px solid #30363d; position: relative; }
        .stack-item { border-left: 4px solid var(--stack); display: flex; justify-content: space-between; }
        .heap-item { border-left: 4px solid #444; }
        .heap-item.mutable { border-left-color: var(--list); }
        .heap-item.immutable { border-left-color: var(--literal); }
        
        .audit-container { width: 100%; max-width: 900px; margin-top: 20px; background: #010409; border: 1px solid #30363d; border-radius: 8px; }
        #auditLog { height: 150px; overflow-y: auto; padding: 15px; font-family: monospace; font-size: 12px; }
        .log-gc { color: var(--gc); font-weight: bold; }
        .log-alloc { color: #7ee787; }
    </style>
</head>
<body>

    <h2>Python Memory Trace & GC</h2>
    
    <div class="controls">
        <input type="text" id="cli" placeholder="X = [1, 2]  OR  Y = X[0]  OR  del X" onkeydown="if(event.key==='Enter') run()">
        <button onclick="run()">Run Command</button>
    </div>

    <div class="main-layout">
        <div class="column">
            <h3 style="color:var(--stack)">STACK</h3>
            <div id="stackView"></div>
        </div>
        <div class="column">
            <h3 style="color:var(--heap)">HEAP</h3>
            <div id="heapView"></div>
        </div>
    </div>

    <div class="audit-container">
        <div id="auditLog">&gt; Interpreter Ready. Enter a command.</div>
    </div>

    <script>
        let stack = {}; 
        let heap = {};  
        let addr = 100;

        function log(msg, cls='') {
            const l = document.getElementById('auditLog');
            l.innerHTML = `<div class="${cls}">[PY] ${msg}</div>` + l.innerHTML;
        }

        function run() {
            let cmd = document.getElementById('cli').value.trim();
            document.getElementById('cli').value = '';
            if (!cmd) return;

            // 1. Handling DELETE (del x)
            if (cmd.startsWith('del ')) {
                let name = cmd.split(' ')[1];
                if (stack[name]) {
                    let target = stack[name];
                    delete stack[name];
                    log(`del ${name}: Name removed from Stack.`, 'log-gc');
                    decreaseRef(target);
                }
            } 
            // 2. Handling ASSIGNMENT (x = ...)
            else if (cmd.includes('=')) {
                let [left, right] = cmd.split('=').map(s => s.trim());
                if (stack[left]) decreaseRef(stack[left]);

                let targetAddr;

                // Case: X = [1, 2]
                if (right.startsWith('[') && right.endsWith(']')) {
                    let items = right.slice(1, -1).split(',').map(i => i.trim());
                    let pointers = items.map(val => createObject(val));
                    targetAddr = "0x" + (addr++);
                    heap[targetAddr] = { val: pointers, type: 'list', refs: 0, isMutable: true };
                    pointers.forEach(p => heap[p].refs++);
                    log(`ALLOC: New list at ${targetAddr} with pointers to members.`, 'log-alloc');
                }
                // Case: Y = X[0]
                else if (right.includes('[') && right.endsWith(']')) {
                    let base = right.split('[')[0];
                    let idx = parseInt(right.match(/\[(.*?)\]/)[1]);
                    if (stack[base] && heap[stack[base]].isMutable) {
                        targetAddr = heap[stack[base]].val[idx];
                        log(`INDEX: Fetched member pointer from ${base} index ${idx}.`);
                    }
                }
                // Case: Literal or Variable copy
                else {
                    targetAddr = stack[right] || createObject(right);
                }

                if (targetAddr) {
                    stack[left] = targetAddr;
                    heap[targetAddr].refs++;
                }
            }
            render();
        }

        function createObject(val) {
            let clean = val.replace(/['"]/g, '');
            // Simple Interning
            for (let a in heap) if (heap[a].val === clean && !heap[a].isMutable) return a;
            
            let a = "0x" + (addr++);
            heap[a] = { val: clean, type: isNaN(clean) ? 'str' : 'int', refs: 0, isMutable: false };
            log(`ALLOC: Created ${heap[a].type} '${clean}' at ${a}.`, 'log-alloc');
            return a;
        }

        function decreaseRef(a) {
            if (!heap[a]) return;
            heap[a].refs--;
            log(`REF_DEC: ${a} refs now ${heap[a].refs}`);
            if (heap[a].refs <= 0) {
                log(`GC: Reclaiming memory at ${a}`, 'log-gc');
                if (heap[a].isMutable) heap[a].val.forEach(p => decreaseRef(p));
                delete heap[a];
            }
        }

        function render() {
            document.getElementById('stackView').innerHTML = Object.keys(stack).map(k => `
                <div class="item stack-item"><b>${k}</b><span>${stack[k]}</span></div>
            `).join('');
            document.getElementById('heapView').innerHTML = Object.keys(heap).map(a => `
                <div class="item heap-item ${heap[a].isMutable?'mutable':'immutable'}">
                    <small>${a}</small><br>
                    <b>${heap[a].isMutable ? '[' + heap[a].val.join(',') + ']' : heap[a].val}</b><br>
                    <small style="color:var(--gc)">Refs: ${heap[a].refs}</small>
                </div>
            `).join('');
        }
    </script>
</body>
</html>
