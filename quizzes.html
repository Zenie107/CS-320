<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>CS 320 Quiz Portal</title>
    <style>
        :root { --primary: #2563eb; --bg: #f8fafc; --text: #1e293b; }
        body { font-family: system-ui, sans-serif; background: var(--bg); color: var(--text); padding: 20px; display: flex; justify-content: center; }
        #app { background: white; padding: 2rem; border-radius: 12px; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); width: 100%; max-width: 500px; }
        .menu-btn { display: block; width: 100%; padding: 15px; margin: 10px 0; border: 2px solid var(--primary); border-radius: 8px; cursor: pointer; background: white; color: var(--primary); font-weight: bold; text-align: left; }
        .menu-btn:hover { background: var(--primary); color: white; }
        .option { display: block; width: 100%; padding: 12px; margin: 8px 0; border: 1px solid #e2e8f0; border-radius: 8px; cursor: pointer; text-align: left; background: white; }
        .hidden { display: none; }
        .correct { background: #dcfce7 !important; border-color: #22c55e !important; }
        .wrong { background: #fee2e2 !important; border-color: #ef4444 !important; }
    </style>
</head>
<body>
<div id="app">
    <div id="menu-view">
        <h1>Select a Class</h1>
        <div id="quiz-list">Loading quizzes...</div>
    </div>

    <div id="quiz-view" class="hidden">
        <button onclick="location.reload()" style="margin-bottom:10px; cursor:pointer;">â¬… Menu</button>
        <div id="progress" style="font-size: 0.8rem; color: #64748b;"></div>
        <h2 id="q-text"></h2>
        <div id="options"></div>
        <p id="feedback"></p>
        <button id="next-btn" class="hidden" onclick="renderQuestion()" style="width:100%; padding:12px; background:#1e293b; color:white; border:none; border-radius:8px; cursor:pointer;">Next</button>
    </div>
</div>

<script>
    let questions = [];
    let currentIdx = 0;

    async function loadManifest() {
        try {
            const res = await fetch('quizzes.json');
            const data = await res.json();
            const list = document.getElementById('quiz-list');
            list.innerHTML = '';
            data.forEach(q => {
                const btn = document.createElement('button');
                btn.className = 'menu-btn';
                btn.innerText = q.title;
                btn.onclick = () => startQuiz(q.id);
                list.appendChild(btn);
            });
        } catch (e) { document.getElementById('quiz-list').innerText = "Add a CSV to /quizzes to begin!"; }
    }

    async function startQuiz(id) {
        const res = await fetch(`quizzes/${id}.csv`);
        const text = await res.text();
        const rows = text.split('\n').filter(r => r.trim() !== '').slice(1);
        
        // Parse and Shuffle
        let allQuestions = rows.map(row => {
            const p = row.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/);
            return { q: p[0], a: [p[1], p[2], p[3], p[4]], correct: parseInt(p[5]) };
        });

        // Fisher-Yates Shuffle Logic
        questions = allQuestions.sort(() => Math.random() - 0.5).slice(0, 10);
        
        document.getElementById('menu-view').classList.add('hidden');
        document.getElementById('quiz-view').classList.remove('hidden');
        renderQuestion();
    }

    function renderQuestion() {
        if (currentIdx >= questions.length) {
            document.getElementById('quiz-view').innerHTML = `<h2>Quiz Over!</h2><p>You finished 10 random questions.</p><button onclick="location.reload()">Back</button>`;
            return;
        }
        const data = questions[currentIdx];
        document.getElementById('progress').innerText = `Question ${currentIdx + 1} of ${questions.length}`;
        document.getElementById('q-text').innerText = data.q;
        const container = document.getElementById('options');
        container.innerHTML = '';
        document.getElementById('next-btn').classList.add('hidden');
        document.getElementById('feedback').innerText = '';

        data.a.forEach((text, i) => {
            const btn = document.createElement('button');
            btn.className = 'option';
            btn.innerText = text;
            btn.onclick = () => {
                const isCorrect = i === data.correct;
                btn.classList.add(isCorrect ? 'correct' : 'wrong');
                document.getElementById('feedback').innerText = isCorrect ? "Correct!" : "Incorrect.";
                document.querySelectorAll('.option').forEach(b => b.disabled = true);
                document.getElementById('next-btn').classList.remove('hidden');
                currentIdx++;
            };
            container.appendChild(btn);
        });
    }
    loadManifest();
</script>
</body>
</html>
