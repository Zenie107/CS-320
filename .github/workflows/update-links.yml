name: Update README Links
on:
  push:
    paths:
      - '**/*.html'
      - '.github/workflows/update-links.yml'

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Generate Links and Update README
        shell: python
        run: |
          import os, re

          # Use the environment variable set by GitHub Actions
          repo_full = os.environ.get('GITHUB_REPOSITORY', '')
          if '/' in repo_full:
              user, repo = repo_full.split('/', 1)
          else:
              user, repo = repo_full, ''

          start_marker = "<!-- LINKS_START -->"
          end_marker = "<!-- LINKS_END -->"

          # 1. Gather all HTML links
          html_items = []
          for root, dirs, files in os.walk("."):
              # skip .git and .github directories
              if "/.git" in root.replace("\\", "/") or "/.github" in root.replace("\\", "/"):
                  continue
              for file in sorted(files):
                  if file.endswith(".html") and file != "index.html":
                      path = os.path.relpath(os.path.join(root, file)).replace("\\", "/").lstrip("./")
                      url = f"https://{user}.github.io/{repo}/{path}"
                      html_items.append((path, url))

          # Build the replacement block
          if html_items:
              links_block = "\n".join([f"* [{p}]({u})" for p, u in html_items])
              block = "### ðŸ”— Project Links\n\n" + links_block + "\n"
          else:
              block = "### ðŸ”— Project Links\n\n_No HTML files found._\n"

          # 2. Read or create README
          readme_path = "README.md"
          if not os.path.exists(readme_path):
              with open(readme_path, "w", encoding="utf-8") as f:
                  f.write("# " + repo + "\n\n")

          with open(readme_path, "r", encoding="utf-8") as f:
              content = f.read()

          # 3. If markers missing, append them (markers stay invisible as HTML comments)
          if start_marker not in content or end_marker not in content:
              content = content.rstrip() + "\n\n" + start_marker + "\n" + end_marker + "\n"

          # 4. Replace the content between markers atomically
          pattern = re.compile(re.escape(start_marker) + r".*?" + re.escape(end_marker), re.S)
          replacement = start_marker + "\n\n" + block + "\n" + end_marker
          new_content = pattern.sub(replacement, content)

          # 5. Write only if changed
          if new_content != content:
              with open(readme_path, "w", encoding="utf-8") as f:
                  f.write(new_content)
              print("README.md updated with latest HTML links.")
          else:
              print("README.md already up to date. No changes made.")

      - name: Commit and Push
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add README.md
          git diff --quiet && git diff --staged --quiet || (git commit -m "docs: auto-update navigation links" && git push)
